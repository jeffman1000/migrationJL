from kfp import dsl
from kfp.dsl import Dataset, Output


@dsl.component(
    packages_to_install=["snowflake-connector-python==3.6.0", "pandas==2.1.4", "pyarrow==14.0.2"]
)
def read_{{ dataset_id }}(
    {{ dataset_param }}: Output[Dataset]
):
    """
    Read {{ dataset_id }} from Snowflake and output as parquet.
    Source Dataiku Dataset: {{ dataset_id }} (ROOT dataset)

    Output Data:
        {{ dataset_param }}: Output artifact containing the data as parquet
    """


# ====================================================================================================
# SNOWFLAKE SOURCE DATASET METADATA
# ====================================================================================================
# ================================================================================================
# DATASET: {{ dataset_id }}
# ================================================================================================
#
# Type: Snowflake source (ROOT dataset)
#
# This is a ROOT dataset - it's the source of the data flow.
#
# Expected schema:
{%- for col in columns %}
#   - {{ col }}
{%- endfor %}
#
# ================================================================================================
# SNOWFLAKE CONNECTION (COMMENTED OUT)
# ================================================================================================
# TODO: Add your Snowflake connection logic here
# Uncomment and configure when ready to read real data
#
# Example implementation:
#
# def get_snowflake_connection():
#     """Get Snowflake connection from secrets or environment."""
#     import snowflake.connector
#     # In production, use Vertex AI secrets or workload identity
#     conn = snowflake.connector.connect(
#         user='<YOUR_USER>',
#         password='<YOUR_PASSWORD>',  # Use secret manager!
#         account='<YOUR_ACCOUNT>',
#         warehouse='<YOUR_WAREHOUSE>',
#         database='<YOUR_DATABASE>',
#         schema='<YOUR_SCHEMA>'
#     )
#     return conn
#
# # Read from Snowflake
# conn = get_snowflake_connection()
# snowflake_table = "DATABASE.SCHEMA.{{ dataset_id|upper }}"
# query = f"SELECT * FROM {snowflake_table}"
# df = pd.read_sql(query, conn)
# conn.close()
#
# # Write to output artifact as parquet
# from pathlib import Path
# output_path = Path({{ dataset_param }}.path)
# output_path.parent.mkdir(parents=True, exist_ok=True)
# df.to_parquet(output_path, index=False)
#
# ================================================================================================
