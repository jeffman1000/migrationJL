"""
{{ scenario_name }}

Generated from Dataiku scenario: {{ scenario_id }}
{% if calls_sub_pipelines %}
This pipeline orchestrates {{ steps|length }} sequential steps, including {{ sub_pipeline_ids|length }} sub-pipeline(s).
{% else %}
This pipeline executes {{ steps|length }} sequential steps.
{% endif %}
"""
from kfp import dsl, compiler
from kfp.dsl import PipelineTask

# Import component functions
{%- for comp in all_components %}
{%- if comp.type == "source" %}
from vertex_pipelines.components.recipes.{{ comp.id | sanitize_component }} import {{ comp.id | sanitize_component }}
{%- elif comp.type == "recipe" %}
from vertex_pipelines.components.recipes.{{ comp.id | sanitize_component }} import {{ comp.id | sanitize_component }}
{%- elif comp.type == "operational" %}
from vertex_pipelines.components.operational.{{ comp.id | sanitize_component }} import {{ comp.id | sanitize_component }}
{%- endif %}
{%- endfor %}

{%- if calls_sub_pipelines %}

# Import sub-pipeline functions
{%- for sub_pipeline_id in sub_pipeline_ids %}
{%- set func_name = sub_pipeline_function_names[sub_pipeline_id] %}
from vertex_pipelines.pipelines.{{ func_name }} import {{ func_name }}
{%- endfor %}
{%- endif %}


@dsl.pipeline(
    name="{{ scenario_name }}",
    description="{{ scenario_description }}"
)
def {{ function_name }}() -> None:
    """
    {{ scenario_description }}

    This pipeline orchestrates {{ steps|length }} sequential step(s).
    Each step executes after the previous step completes (enforced with .after()).
    """
    {%- set ns = namespace(prev_step_var=None, dataset_to_task={}) %}
    {%- for step in steps %}

    # Step {{ loop.index }}: {{ step.description }}
    {%- if step.sub_pipeline_id %}
    # Calls sub-pipeline: {{ step.sub_pipeline_id }}
    {%- set func_name = sub_pipeline_function_names[step.sub_pipeline_id] %}
    step_{{ loop.index }}_task = {{ func_name }}()
    {%- if ns.prev_step_var %}
    step_{{ loop.index }}_task.after({{ ns.prev_step_var }})
    {%- endif %}
    {%- set ns.prev_step_var = "step_" ~ loop.index ~ "_task" %}

    {%- elif step.components|length > 0 %}
    {%- for comp in step.components %}
    {%- if comp.type == "source" %}
    # Source dataset: {{ comp.outputs[0] if comp.outputs else comp.id }}
    {{ comp.id | sanitize_component }}_task: PipelineTask = {{ comp.id | sanitize_component }}()
    {%- if comp.outputs %}
    {%- for output_ds in comp.outputs %}
    {%- do ns.dataset_to_task.update({output_ds: comp.id | sanitize_component ~ "_task"}) %}
    {%- endfor %}
    {%- endif %}
    {%- elif comp.type == "recipe" %}
    # Recipe: {{ comp.id }}
    # Transform: {{ comp.inputs|join(', ') }} → {{ comp.outputs|join(', ') }}
    {{ comp.id | sanitize_component }}_task = {{ comp.id | sanitize_component }}(
        {%- for input_name in comp.inputs %}
        {%- if input_name not in root_datasets %}
        {%- set input_task = ns.dataset_to_task.get(input_name, input_name | sanitize ~ "_task") %}
        {{ input_name | sanitize }}={{ input_task }}.output,
        {%- endif %}
        {%- endfor %}
    )
    {%- if comp.outputs %}
    {%- for output_ds in comp.outputs %}
    {%- do ns.dataset_to_task.update({output_ds: comp.id | sanitize_component ~ "_task"}) %}
    {%- endfor %}
    {%- endif %}
    {%- elif comp.type == "operational" %}
    # {{ comp.step_type }} step: {{ comp.description }}
    {{ comp.id | sanitize_component }}_task = {{ comp.id | sanitize_component }}()
    {%- endif %}
    {%- if ns.prev_step_var and loop.first %}
    # This component starts a new step, so it depends on the previous step
    {{ comp.id | sanitize_component }}_task.after({{ ns.prev_step_var }})
    {%- endif %}
    {%- if loop.last %}
    {%- set ns.prev_step_var = comp.id | sanitize_component ~ "_task" %}
    {%- endif %}
    {%- endfor %}
    {%- endif %}
    {%- endfor %}


if __name__ == "__main__":
    # Compile the pipeline to YAML
    compiler.Compiler().compile(
        pipeline_func={{ function_name }},
        package_path="{{ scenario_id }}.yaml"
    )
    print(f"✅ Pipeline compiled to: {{ scenario_id }}.yaml")
    print(f"   - Steps: {{ steps|length }}")
    print(f"   - Components: {{ all_components|length }}")
    {%- if calls_sub_pipelines %}
    print(f"   - Sub-pipelines: {{ sub_pipeline_ids|length }}")
    {%- endif %}
    print(f"   - Root datasets: {{ root_datasets|length }}")
    print(f"   - Target datasets: {{ target_datasets|length }}")
